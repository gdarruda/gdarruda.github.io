---
layout: post
title: "Como ler Kafka?"
comments: true
mathjax: true
description: "Lendo tópicos Kafka de forma prática"
keywords: "backpressure, micro-batch, atores"
---

Escrevi sobre as dores de se trabalhar com [engenharia de dados]({{site.url}}/2023/03/04/engenharia-dados.html), muitas delas aparecem quando se utiliza Kafka. Não é uma crítica ao software – tem ótimas sacadas de design para escalabilidade como o [princípio de zero cópias](https://kafka.apache.org/documentation/#maximizingefficiency), [usar diretamente o  filesystem](https://kafka.apache.org/documentation/#design_filesystem), [pull ao invés de push](https://kafka.apache.org/documentation/#design_pull) e [load balancing](https://kafka.apache.org/documentation/#design_loadbalancing) – mas tudo isso traz uma complexidade intrínseca que cobra um preço dos usuários.

Quando se fala de performance do Kafka, discute-se muitas questões de infra do ambiente (*e.g.* número de partições, réplicas e picos de uso). O que eu vou abordar é mais do lado da programação, como desenhar o comsumidor pensando no tipo de tarefa, que pode ser aplicar um modelo de machine learning ou salvar em um banco de dados por exemplo.

Ler dados de um tópico costuma ser bem rápido, rápido demais inclusive. O problema costuma variar entre dois extremos: baixo *throughout*, porque a aplicação quer manter um consumo *exactly-once* sem paralelismo, ou *overflow* do consumidor porque ela está lendo mais rápido do que consegue processar.

Nesse post, vou abordar a questão da como desenhar o consumo de tópicos. A ideia é passar os conceitos mínimos para entender os problemas e pontos de atenção, mas sem entrar em muitos detalhes da arquitetura do Kafka que estão bem cobertos em outros materiais.

## Por que eventos?

A ideia de eventos se popularizou bastante nos últimos anos, um exemplo em os eventos funcionam muito bem, é o problema de mensageria: quando algo acontece no sistema, uma compra confirmada em um sistema de e-commerce por exemplo, pode ser necessário notificar o usuário via e-mail.

A solução imediata é fazer uma integração síncrona via API, confirmando a compra após tudo ser finalizando, incluindo o envio do e-mail.

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 744.5 232.4615478515625" width="700" height="200">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
      @font-face {
        font-family: "Assistant";
        src: url("https://excalidraw.com/Assistant-Regular.woff2");
      }
    </style>
    
  </defs>
  <g stroke-linecap="round" transform="translate(10 115.3233642578125) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C8.86 9.65, 15.43 4.2, 16.91 1.45 M4.44 15.79 C7.59 12.42, 12.34 7.87, 16.91 1.45 M4.57 27.83 C12.53 17.52, 18.04 11.45, 27.54 1.41 M4.57 27.83 C11.07 20.45, 16.43 14.27, 27.54 1.41 M4.71 39.87 C12.52 29.24, 18.49 20.53, 38.17 1.38 M4.71 39.87 C16.81 24.4, 30.7 10.97, 38.17 1.38 M3.53 53.42 C20.88 33.75, 34.23 19.6, 48.8 1.34 M3.53 53.42 C20.94 34.12, 38.59 11.96, 48.8 1.34 M6.94 61.68 C18.71 49.01, 32.25 36.15, 59.43 1.31 M6.94 61.68 C22.13 42.65, 37.89 24.68, 59.43 1.31 M13.64 66.18 C34.55 45.58, 53.64 20.92, 70.06 1.27 M13.64 66.18 C30.06 46.48, 46.49 27.15, 70.06 1.27 M24.27 66.14 C35.04 52.41, 46.86 35.61, 80.03 1.99 M24.27 66.14 C41.96 44.78, 59.9 24.81, 80.03 1.99 M34.9 66.11 C55.44 42.94, 74.62 19.79, 90.66 1.96 M34.9 66.11 C57.06 41.59, 79.07 15.6, 90.66 1.96 M45.53 66.08 C59.29 52.51, 71.58 34.54, 101.29 1.92 M45.53 66.08 C60.58 48.85, 75.05 32.65, 101.29 1.92 M55.5 66.8 C69.72 49.87, 88.67 29.5, 111.92 1.89 M55.5 66.8 C69.11 53.8, 80.28 38.34, 111.92 1.89 M66.13 66.76 C77.3 53.14, 90.7 37.6, 122.55 1.86 M66.13 66.76 C88.08 40.66, 111.7 16, 122.55 1.86 M76.76 66.73 C95.33 43.83, 114.6 23.94, 133.18 1.82 M76.76 66.73 C90.39 50.08, 105.47 33.97, 133.18 1.82 M87.39 66.69 C101.29 53.46, 114.3 36.05, 139.22 7.07 M87.39 66.69 C102.65 48.95, 118.39 29.64, 139.22 7.07 M98.02 66.66 C109.59 53, 118.27 44.19, 143.29 14.58 M98.02 66.66 C113.53 48.79, 129.32 29.31, 143.29 14.58 M108.65 66.62 C119.66 52.69, 131.01 40.19, 143.42 26.62 M108.65 66.62 C115.66 57.45, 122.56 49.98, 143.42 26.62 M118.62 67.34 C125.34 59.63, 131.75 49.3, 142.9 39.42 M118.62 67.34 C123.26 61.45, 128.86 55.82, 142.9 39.42" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C57.7 -2.46, 99.35 -2.85, 125.25 0 M15.75 0 C57.22 0.07, 100.63 -0.03, 125.25 0 M125.25 0 C136.35 0.82, 140.49 4.11, 141 15.75 M125.25 0 C136.1 2.18, 141.13 4.56, 141 15.75 M141 15.75 C139.35 25.64, 143.11 38.28, 141 47.25 M141 15.75 C140.92 24.74, 141.45 33.45, 141 47.25 M141 47.25 C139.07 59.13, 136.45 61.71, 125.25 63 M141 47.25 C142.62 59.57, 134 64.44, 125.25 63 M125.25 63 C90.82 64.73, 54.62 62.57, 15.75 63 M125.25 63 C96.44 62, 68.69 62.1, 15.75 63 M15.75 63 C4.59 61.78, -0.64 59.68, 0 47.25 M15.75 63 C3.84 64.96, 0.28 56.49, 0 47.25 M0 47.25 C-0.09 36.55, 1.12 28.64, 0 15.75 M0 47.25 C0.49 36.71, 0.08 24.86, 0 15.75 M0 15.75 C-0.18 5.13, 6.1 -1.35, 15.75 0 M0 15.75 C0.92 4.73, 5.15 -1.4, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(37.68000030517578 121.8233642578125) rotate(0 42.81999969482422 25)"><text x="42.81999969482422" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Sistema </text><text x="42.81999969482422" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Vendas</text></g><g stroke-linecap="round"><g transform="translate(163 146.51735208528498) rotate(0 38.5 -0.07279846264141465)"><path d="M-0.24 -0.76 C12.56 -0.56, 65.02 0.81, 77.74 0.76 M1.83 1.45 C14.45 1.37, 64.41 -0.61, 77.18 -0.88" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(163 146.51735208528498) rotate(0 38.5 -0.07279846264141465)"><path d="M53.97 8.4 C61.51 6.17, 73.07 -0.16, 77.18 -0.88 M53.97 8.4 C58.57 6.38, 63.58 3.42, 77.18 -0.88" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(163 146.51735208528498) rotate(0 38.5 -0.07279846264141465)"><path d="M53.43 -8.69 C61.11 -4.46, 72.88 -4.32, 77.18 -0.88 M53.43 -8.69 C58.17 -6.84, 63.29 -5.93, 77.18 -0.88" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(252 80.4615478515625) rotate(0 117 71)"><path d="M32 0 C81.9 2.23, 130.66 2.71, 202 0 M32 0 C74.94 1.06, 116.43 0.03, 202 0 M202 0 C224.26 -0.53, 233.07 10.79, 234 32 M202 0 C221.09 0.53, 233.18 9, 234 32 M234 32 C233 59.28, 236.1 85.71, 234 110 M234 32 C234.12 58.98, 233.47 86.7, 234 110 M234 110 C232.42 133.28, 224.04 142.61, 202 142 M234 110 C232.06 131.01, 222.53 140.72, 202 142 M202 142 C159.64 142.8, 120.1 142.7, 32 142 M202 142 C142.06 143.47, 83.64 143.78, 32 142 M32 142 C10.59 143.46, 1.4 130.4, 0 110 M32 142 C8.82 142.29, -1.71 130.46, 0 110 M0 110 C-0.61 89.3, 0.02 71.24, 0 32 M0 110 C0.07 81.25, -0.62 54.26, 0 32 M0 32 C-1.92 9.43, 11.54 -0.1, 32 0 M0 32 C-1.46 8.86, 10.29 0.41, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(273 94.8615478515625) rotate(0 96.99998474121094 57.941333333333304)"><text x="0" y="13.321333333333328" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="29.875999999999987" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="46.430666666666646" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="62.9853333333333" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="79.53999999999996" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="96.09466666666663" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="112.64933333333327" font-family="Cascadia, Segoe UI Emoji" font-size="13.795555555555548px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(593.5 112.9615478515625) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C8.15 9.69, 14.53 5.43, 16.91 1.45 M4.44 15.79 C9.25 10.04, 14.39 4.5, 16.91 1.45 M4.57 27.83 C13.37 18.08, 21.89 6.07, 27.54 1.41 M4.57 27.83 C12.96 19.53, 20.49 10.78, 27.54 1.41 M4.71 39.87 C15.55 28.35, 26.88 14.83, 38.17 1.38 M4.71 39.87 C13.31 29.72, 21.01 19.98, 38.17 1.38 M3.53 53.42 C15.36 38.46, 31.09 24.46, 48.8 1.34 M3.53 53.42 C17.38 38.41, 29.65 21.92, 48.8 1.34 M6.94 61.68 C22.8 42.54, 40.83 22.73, 59.43 1.31 M6.94 61.68 C18.96 47.38, 31.23 33.32, 59.43 1.31 M13.64 66.18 C31.87 48.01, 50.28 25.8, 70.06 1.27 M13.64 66.18 C27.62 51.25, 42.68 33.61, 70.06 1.27 M24.27 66.14 C41.54 42.65, 62.32 22.95, 80.03 1.99 M24.27 66.14 C37.46 49.77, 50.16 35.69, 80.03 1.99 M34.9 66.11 C47.83 50.06, 60.74 35.04, 90.66 1.96 M34.9 66.11 C57.58 40.45, 79.17 16.35, 90.66 1.96 M45.53 66.08 C57.3 54.02, 70.17 40.33, 101.29 1.92 M45.53 66.08 C63.73 46.4, 80.15 25.82, 101.29 1.92 M55.5 66.8 C73.54 44.27, 92.25 26.01, 111.92 1.89 M55.5 66.8 C76.7 40.15, 99.58 15.21, 111.92 1.89 M66.13 66.76 C83.4 48.6, 97.07 29.24, 122.55 1.86 M66.13 66.76 C84.01 46.86, 101.29 26.59, 122.55 1.86 M76.76 66.73 C96.18 44.03, 117.27 21.26, 133.18 1.82 M76.76 66.73 C97.15 43.57, 118.41 17.95, 133.18 1.82 M87.39 66.69 C100.45 53.99, 113 39.11, 139.22 7.07 M87.39 66.69 C104.02 45.06, 122.6 25.29, 139.22 7.07 M98.02 66.66 C110.22 56.67, 117.52 42.71, 143.29 14.58 M98.02 66.66 C110.38 51.16, 123.59 37.08, 143.29 14.58 M108.65 66.62 C120.34 50.93, 135.8 35.3, 143.42 26.62 M108.65 66.62 C121.46 51.39, 134.84 36.2, 143.42 26.62 M118.62 67.34 C125.91 60.36, 133.26 52.09, 142.9 39.42 M118.62 67.34 C126.46 56.34, 135.81 47.63, 142.9 39.42" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C51.29 2.67, 87.1 0.93, 125.25 0 M15.75 0 C39.12 -0.41, 63.93 -0.13, 125.25 0 M125.25 0 C136.54 0.11, 139.41 6.67, 141 15.75 M125.25 0 C134.66 2.23, 139.16 5.92, 141 15.75 M141 15.75 C142.95 25.07, 141.19 39.06, 141 47.25 M141 15.75 C140.69 23.32, 141.26 31.95, 141 47.25 M141 47.25 C142.38 58.88, 137.34 63.08, 125.25 63 M141 47.25 C141.52 59.33, 135.1 64.14, 125.25 63 M125.25 63 C89.67 61.35, 56.19 62.89, 15.75 63 M125.25 63 C102.08 63.61, 78.72 61.87, 15.75 63 M15.75 63 C5.6 62.55, 1.38 58.99, 0 47.25 M15.75 63 C7.32 63.32, 2.26 56.07, 0 47.25 M0 47.25 C0.76 33.51, 0.19 22.93, 0 15.75 M0 47.25 C0.71 35.33, 0.11 23.02, 0 15.75 M0 15.75 C-0.1 4.8, 7.11 -0.46, 15.75 0 M0 15.75 C1.62 6.79, 3.99 1.87, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(610.4599990844727 131.9615478515625) rotate(0 53.540000915527344 12.5)"><text x="53.540000915527344" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Mensageria</text></g><g stroke-linecap="round"><g transform="translate(502.0000000000002 149.1158370359096) rotate(0 38.999999999999886 0.4969342584564762)"><path d="M-0.95 0.48 C12.17 0.77, 66.03 0.66, 79.12 0.68 M0.75 -0.31 C13.78 0.24, 66.12 1.72, 78.77 2.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(502.0000000000002 149.1158370359096) rotate(0 38.999999999999886 0.4969342584564762)"><path d="M55.05 9.95 C63.79 9.39, 70.32 4.24, 78.77 2.05 M55.05 9.95 C60.94 8.9, 67.47 5.96, 78.77 2.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(502.0000000000002 149.1158370359096) rotate(0 38.999999999999886 0.4969342584564762)"><path d="M55.52 -7.14 C63.96 -2.04, 70.34 -1.52, 78.77 2.05 M55.52 -7.14 C61.45 -3.62, 67.85 -2, 78.77 2.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(230 10) rotate(0 145.89398193359375 17.5)"><text x="0" y="24.528" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Comunicação síncrona</text></g></svg>

Mesmo em uma escala pequena, esse tipo de solução normalmente pode gerar uma série de problemas:

* enviar e-mails é um processo demorado, segurar uma requisição até finalizar tudo, pode sobrecarregar tanto os sistema de vendas quanto a mensageria;

* é comum usar serviços externos para envio de e-mails, o que aumenta problemas de latência e riscos de indisponibilidade;

* nem sempre as comunicações precisam (ou devem) ser enviadas logo após a compra, comunicações e canais podem ter políticas de envio complexas;

* o e-mail normalmente não é parte crítica do processo: faz mais sentido vender e não enviar o e-mail, que perder uma venda por não conseguir enviar o e-mail.

Dado esse cenário, é normal partir para uma solução orientada a eventos, adicionando um [message broker](https://en.wikipedia.org/wiki/Message_broker) para mediar a comunicação entre o transacional e a mensageria.

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 731.5 301.49017333984375" width="700" height="300">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
      @font-face {
        font-family: "Assistant";
        src: url("https://excalidraw.com/Assistant-Regular.woff2");
      }
    </style>
    
  </defs>
  <g stroke-linecap="round" transform="translate(10 81.3233642578125) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C2.61 17.02, 8.26 10.5, 17.56 0.69 M0.5 20.31 C4.75 15.06, 9.37 8.58, 17.56 0.69 M0.64 32.35 C9.06 19.89, 21.85 9.64, 28.19 0.66 M0.64 32.35 C6.3 24.24, 13.37 17.08, 28.19 0.66 M0.77 44.4 C14.69 29.01, 23.97 14.41, 38.82 0.62 M0.77 44.4 C8.22 35.06, 15.97 26.14, 38.82 0.62 M2.22 54.93 C15.45 41.41, 27.99 27.02, 49.45 0.59 M2.22 54.93 C18.67 36.99, 33.09 19.58, 49.45 0.59 M7.6 60.93 C21.93 44.88, 35.73 28.26, 60.08 0.55 M7.6 60.93 C25.49 41.04, 43.14 21.62, 60.08 0.55 M16.92 62.41 C34.5 46.44, 47.94 28.09, 70.06 1.27 M16.92 62.41 C33.63 43.09, 51.78 21.98, 70.06 1.27 M27.55 62.37 C41.3 44.4, 56.26 30.73, 80.69 1.24 M27.55 62.37 C44.01 42.91, 60.69 25.35, 80.69 1.24 M38.18 62.34 C49.43 50.5, 61.09 37.08, 91.32 1.2 M38.18 62.34 C60.31 38.51, 80.31 13.21, 91.32 1.2 M48.81 62.3 C65.01 44.32, 77.44 29.84, 101.95 1.17 M48.81 62.3 C65.47 43.3, 81.59 25.23, 101.95 1.17 M58.78 63.02 C81.18 41.38, 101.62 16.75, 112.58 1.14 M58.78 63.02 C78.15 42.22, 97.72 20.29, 112.58 1.14 M69.41 62.99 C81.5 46.51, 94.55 32.68, 123.21 1.1 M69.41 62.99 C90.59 39.02, 109.63 14.68, 123.21 1.1 M80.04 62.95 C95 47.21, 108.79 29.37, 133.18 1.82 M80.04 62.95 C100.04 40.75, 118.03 17.39, 133.18 1.82 M90.67 62.92 C101.94 48.07, 117.27 32.99, 139.22 7.07 M90.67 62.92 C105.43 44.22, 120.5 26.64, 139.22 7.07 M101.3 62.88 C113.14 46.81, 126.04 32.77, 141.32 16.85 M101.3 62.88 C110.47 50.6, 120.91 40.13, 141.32 16.85 M111.93 62.85 C121.81 53.3, 132.33 39.74, 140.8 29.64 M111.93 62.85 C122.38 50.32, 132.39 39.38, 140.8 29.64 M121.9 63.57 C128.36 58.84, 132.26 52.67, 140.93 41.68 M121.9 63.57 C128.66 55.31, 136.73 46.53, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C54.44 1.86, 94.42 1.8, 125.25 0 M15.75 0 C42.57 0.04, 70.27 -1.42, 125.25 0 M125.25 0 C133.79 0.61, 141.85 6.04, 141 15.75 M125.25 0 C136.23 1.35, 140.66 5.71, 141 15.75 M141 15.75 C140.53 23.75, 141.85 36.17, 141 47.25 M141 15.75 C140.83 26.17, 139.86 34.96, 141 47.25 M141 47.25 C139.29 58.72, 135.06 61.73, 125.25 63 M141 47.25 C142.25 56.98, 136.31 62.61, 125.25 63 M125.25 63 C98 64.83, 65.48 63.34, 15.75 63 M125.25 63 C91.62 61.45, 58.93 62.01, 15.75 63 M15.75 63 C6.52 62.35, -0.94 59.02, 0 47.25 M15.75 63 C4.17 62.12, 1.11 59.53, 0 47.25 M0 47.25 C-0.39 36.53, -2 29.65, 0 15.75 M0 47.25 C-0.33 41.33, 0.06 33.93, 0 15.75 M0 15.75 C0.47 5.32, 7.15 -0.92, 15.75 0 M0 15.75 C-2.17 3.31, 5.77 -1.62, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(37.68000030517578 87.8233642578125) rotate(0 42.81999969482422 25)"><text x="42.81999969482422" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Sistema </text><text x="42.81999969482422" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Vendas</text></g><g stroke-linecap="round"><g transform="translate(162.0726611011055 115.73381683193003) rotate(0 61.69805502204872 0.8341756103389741)"><path d="M0.5 -0.6 C21.06 -0.26, 103.55 1.75, 123.92 2.23 M-0.7 1.71 C19.71 1.67, 102.26 0.63, 123.24 0.41" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(162.0726611011055 115.73381683193003) rotate(0 61.69805502204872 0.8341756103389741)"><path d="M99.85 9.23 C106.91 6.96, 116.91 1.86, 123.24 0.41 M99.85 9.23 C107.22 6.61, 116.95 3.56, 123.24 0.41" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(162.0726611011055 115.73381683193003) rotate(0 61.69805502204872 0.8341756103389741)"><path d="M99.65 -7.87 C106.81 -4.25, 116.88 -3.44, 123.24 0.41 M99.65 -7.87 C107.04 -4.4, 116.84 -1.37, 123.24 0.41" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(121 186.79488118489587) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C61.75 -1.65, 99.06 -1.08, 132.33 0 M23.67 0 C46.83 0.06, 69.36 0.25, 132.33 0 M132.33 0 C147.81 0.4, 155.94 7.31, 156 23.67 M132.33 0 C148.65 -0.43, 154.45 8.97, 156 23.67 M156 23.67 C156.21 42.02, 157.97 58.32, 156 71 M156 23.67 C155.25 38.85, 156.14 54.97, 156 71 M156 71 C156.49 86.44, 147.41 93, 132.33 94.67 M156 71 C156.02 88.77, 150.2 92.6, 132.33 94.67 M132.33 94.67 C96.04 94.35, 62.53 96.1, 23.67 94.67 M132.33 94.67 C98.67 94.95, 65.48 93.93, 23.67 94.67 M23.67 94.67 C8.85 96.22, -0.06 88.35, 0 71 M23.67 94.67 C6.23 94.5, -1.57 84.76, 0 71 M0 71 C-1.47 54.12, 1.33 38.06, 0 23.67 M0 71 C0.84 59.23, -1.05 47.53, 0 23.67 M0 23.67 C0.46 6.48, 6.29 1.17, 23.67 0 M0 23.67 C-0.65 10.04, 8.93 1.37, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(135 196.39488118489584) rotate(0 64.66665649414062 38.62755555555552)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(580.5 85.9615478515625) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C3.38 17.17, 9.9 9.57, 17.56 0.69 M0.5 20.31 C4.67 15.5, 7.89 11.38, 17.56 0.69 M0.64 32.35 C6.06 26.2, 14.43 17.27, 28.19 0.66 M0.64 32.35 C10.83 19.26, 22.6 8.54, 28.19 0.66 M0.77 44.4 C11.27 32.64, 20.17 21.21, 38.82 0.62 M0.77 44.4 C14.05 29.05, 26.98 13.53, 38.82 0.62 M2.22 54.93 C20.39 34.84, 34.59 14.36, 49.45 0.59 M2.22 54.93 C15.58 39.58, 30.01 23.03, 49.45 0.59 M7.6 60.93 C27.74 38.85, 43.18 15.95, 60.08 0.55 M7.6 60.93 C27.45 38.41, 46.41 15.7, 60.08 0.55 M16.92 62.41 C27.13 46.98, 41.91 35.39, 70.06 1.27 M16.92 62.41 C34.45 42.49, 51.73 22.03, 70.06 1.27 M27.55 62.37 C45.55 41.88, 59.9 25.44, 80.69 1.24 M27.55 62.37 C43.57 44.51, 58.73 24.26, 80.69 1.24 M38.18 62.34 C54.47 41.78, 72.66 23.03, 91.32 1.2 M38.18 62.34 C58.74 40, 77.2 17.79, 91.32 1.2 M48.81 62.3 C66.24 45.9, 79.03 24.09, 101.95 1.17 M48.81 62.3 C67.44 41.39, 84.67 19.37, 101.95 1.17 M58.78 63.02 C76.42 42.06, 92.91 22.02, 112.58 1.14 M58.78 63.02 C72.01 49.96, 85.03 34.76, 112.58 1.14 M69.41 62.99 C89.55 38.31, 110.65 15.99, 123.21 1.1 M69.41 62.99 C86.37 43.28, 105.07 21.33, 123.21 1.1 M80.04 62.95 C98.17 39.84, 119.93 18.27, 133.18 1.82 M80.04 62.95 C91.11 50.34, 102.5 38.41, 133.18 1.82 M90.67 62.92 C103.32 47.43, 117.61 32.68, 139.22 7.07 M90.67 62.92 C103.33 47.44, 117.91 32.77, 139.22 7.07 M101.3 62.88 C112.11 51.89, 122.01 38.6, 141.32 16.85 M101.3 62.88 C112.41 50.09, 124.76 35.68, 141.32 16.85 M111.93 62.85 C122.47 51.44, 129.44 42.93, 140.8 29.64 M111.93 62.85 C122.98 50.48, 135.29 36.07, 140.8 29.64 M121.9 63.57 C126.37 56.97, 130.25 51.82, 140.93 41.68 M121.9 63.57 C128.84 55.21, 136.77 45.84, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C40.3 -1.63, 69.09 1.18, 125.25 0 M15.75 0 C52.75 -0.44, 90.02 -0.93, 125.25 0 M125.25 0 C136.22 -0.37, 139.65 6.19, 141 15.75 M125.25 0 C137.72 -0.01, 139.46 5.49, 141 15.75 M141 15.75 C141.99 23.63, 142.28 34.24, 141 47.25 M141 15.75 C141.41 23.03, 140.82 29.82, 141 47.25 M141 47.25 C141.02 59.48, 137.57 61.2, 125.25 63 M141 47.25 C141.38 57.9, 135.29 60.81, 125.25 63 M125.25 63 C93.06 65.18, 60 62.97, 15.75 63 M125.25 63 C85.93 63.36, 45.61 63.37, 15.75 63 M15.75 63 C3.81 62.86, -1.37 56, 0 47.25 M15.75 63 C6.53 60.74, 2.24 55.53, 0 47.25 M0 47.25 C-1.36 38.34, -0.06 30.4, 0 15.75 M0 47.25 C0.53 38.55, -0.5 31.84, 0 15.75 M0 15.75 C-0.57 7.12, 6.16 1.19, 15.75 0 M0 15.75 C2.23 3.44, 4.42 2.11, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(597.4599990844727 104.9615478515625) rotate(0 53.540000915527344 12.5)"><text x="53.540000915527344" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Mensageria</text></g><g stroke-linecap="round"><g transform="translate(448.0000000000002 118.38565787327343) rotate(0 61.64009241943421 0.7880712501122673)"><path d="M0.51 0.47 C21.29 0.79, 103.1 2.05, 123.53 2.28 M-0.68 -0.33 C20.07 -0.38, 102.22 -0.07, 122.71 0.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(448.0000000000002 118.38565787327343) rotate(0 61.64009241943421 0.7880712501122673)"><path d="M99.1 8.73 C104.62 7.39, 109.77 5.02, 122.71 0.52 M99.1 8.73 C106.89 5.99, 113.54 4.02, 122.71 0.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(448.0000000000002 118.38565787327343) rotate(0 61.64009241943421 0.7880712501122673)"><path d="M99.34 -8.36 C104.87 -6.26, 109.97 -5.17, 122.71 0.52 M99.34 -8.36 C107.05 -5.64, 113.62 -2.14, 122.71 0.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(208 10) rotate(0 162.83396911621094 17.5)"><text x="0" y="24.528" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Comunicação assíncrona</text></g><g stroke-linecap="round" transform="translate(295.75 87.99017333984375) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C5.58 13.71, 12.71 4.07, 17.56 0.69 M0.5 20.31 C7.6 12.34, 13.43 4.07, 17.56 0.69 M0.64 32.35 C7.72 20.09, 16.86 13.97, 28.19 0.66 M0.64 32.35 C10.02 21.86, 17.83 12.81, 28.19 0.66 M0.77 44.4 C9.33 34.05, 20.03 23.79, 38.82 0.62 M0.77 44.4 C8.7 34.37, 18.59 25.62, 38.82 0.62 M2.22 54.93 C13.02 44.93, 21.91 31.27, 49.45 0.59 M2.22 54.93 C18.23 36.61, 35.9 16.45, 49.45 0.59 M7.6 60.93 C22.66 41.52, 41.17 21.89, 60.08 0.55 M7.6 60.93 C23.85 41.62, 40.68 22.85, 60.08 0.55 M16.92 62.41 C29.24 48.48, 44.03 29.3, 70.06 1.27 M16.92 62.41 C33.31 43.93, 48.58 24.46, 70.06 1.27 M27.55 62.37 C38.86 50.32, 49.84 35.33, 80.69 1.24 M27.55 62.37 C47.06 39.31, 67.37 16.69, 80.69 1.24 M38.18 62.34 C56.72 39.41, 78.8 18.01, 91.32 1.2 M38.18 62.34 C54.33 44.29, 68.76 25.76, 91.32 1.2 M48.81 62.3 C62.22 48.24, 77 30.96, 101.95 1.17 M48.81 62.3 C68.37 41.07, 86.32 18.89, 101.95 1.17 M58.78 63.02 C72.97 44.53, 91.57 26.89, 112.58 1.14 M58.78 63.02 C70.97 46.97, 84.12 31.86, 112.58 1.14 M69.41 62.99 C92.31 39.61, 112.77 15.02, 123.21 1.1 M69.41 62.99 C82.65 46.66, 97.19 32.14, 123.21 1.1 M80.04 62.95 C98.28 44.68, 114.51 22.91, 133.18 1.82 M80.04 62.95 C100.96 39.87, 121.01 15.91, 133.18 1.82 M90.67 62.92 C109.33 41.3, 127.27 21.74, 139.22 7.07 M90.67 62.92 C104.34 46.27, 119.08 30.07, 139.22 7.07 M101.3 62.88 C117.98 44.15, 129.9 27.15, 141.32 16.85 M101.3 62.88 C113.26 48.53, 126.35 35.03, 141.32 16.85 M111.93 62.85 C122.53 51.92, 132.42 42.28, 140.8 29.64 M111.93 62.85 C118.02 55.32, 124.4 48.56, 140.8 29.64 M121.9 63.57 C126.48 57.43, 128.46 55.35, 140.93 41.68 M121.9 63.57 C129.31 56.47, 135.53 47.82, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C52.69 -0.4, 89.05 -0.68, 125.25 0 M15.75 0 C38.14 0.15, 59.23 0.18, 125.25 0 M125.25 0 C136.24 1.41, 141.45 4.25, 141 15.75 M125.25 0 C135.7 -0.63, 141.18 3.02, 141 15.75 M141 15.75 C140.73 27.56, 139.38 35.5, 141 47.25 M141 15.75 C140.19 27.55, 140.28 41.49, 141 47.25 M141 47.25 C142.89 57.83, 136.97 61.33, 125.25 63 M141 47.25 C140.31 58.76, 133.96 61.77, 125.25 63 M125.25 63 C82.29 64.99, 38.63 62.95, 15.75 63 M125.25 63 C91.59 62.55, 55.74 63.65, 15.75 63 M15.75 63 C4.05 64.54, -0.2 58.58, 0 47.25 M15.75 63 C3.4 64.51, -1.57 56.6, 0 47.25 M0 47.25 C1.43 35.99, 1.08 22.11, 0 15.75 M0 47.25 C-0.18 38.24, -0.41 29.66, 0 15.75 M0 15.75 C0.61 6.47, 6.8 0.23, 15.75 0 M0 15.75 C-1.52 3.47, 4.33 1.76, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(320.11000061035156 94.49017333984375) rotate(0 46.13999938964844 25)"><text x="46.13999938964844" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Message </text><text x="46.13999938964844" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Brocker</text></g><g stroke-linecap="round" transform="translate(288.25 185.15684000651038) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C55.19 -1.03, 88 2.44, 132.33 0 M23.67 0 C61.43 -1.08, 98.5 0.13, 132.33 0 M132.33 0 C148.45 0.26, 154.83 9.69, 156 23.67 M132.33 0 C147.14 2.28, 155.45 7.56, 156 23.67 M156 23.67 C156.03 39.76, 155.67 58.7, 156 71 M156 23.67 C155.28 35.13, 154.97 47.13, 156 71 M156 71 C157.93 88.42, 148.73 96.62, 132.33 94.67 M156 71 C155.48 86.35, 150.21 95.63, 132.33 94.67 M132.33 94.67 C97.57 92.87, 61.05 95.29, 23.67 94.67 M132.33 94.67 C91.99 93.96, 50.68 94.21, 23.67 94.67 M23.67 94.67 C7.35 94.91, 0.37 88.7, 0 71 M23.67 94.67 C6.05 96.13, -1.8 87.78, 0 71 M0 71 C1.71 50.75, 0.76 33.36, 0 23.67 M0 71 C-0.63 56.34, 0.3 43.12, 0 23.67 M0 23.67 C-0.43 9.59, 7.93 -1.27, 23.67 0 M0 23.67 C-1.6 7.52, 6.54 0.78, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(302.25 194.7568400065104) rotate(0 64.6666488647461 38.62755555555552)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 3}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(459.25 184.15684000651038) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C54.41 1.45, 80.75 -0.01, 132.33 0 M23.67 0 C63.44 -0.28, 103.04 -1.32, 132.33 0 M132.33 0 C149.25 -0.56, 157.31 8.45, 156 23.67 M132.33 0 C148.33 1.41, 153.78 9.55, 156 23.67 M156 23.67 C156.06 33.85, 156.4 46.47, 156 71 M156 23.67 C156.66 38.47, 155.22 54.78, 156 71 M156 71 C154.45 85.35, 147.36 93.54, 132.33 94.67 M156 71 C154.5 87.89, 149.1 93.81, 132.33 94.67 M132.33 94.67 C96.25 95.04, 62.2 93.18, 23.67 94.67 M132.33 94.67 C105.46 94.11, 79.87 95.81, 23.67 94.67 M23.67 94.67 C7.1 95.75, 1.68 88.62, 0 71 M23.67 94.67 C8.83 93.07, 1.59 88.27, 0 71 M0 71 C1.1 53.19, -2 38.53, 0 23.67 M0 71 C-0.27 56.63, -0.9 40.52, 0 23.67 M0 23.67 C-1.42 8.58, 6.83 0.68, 23.67 0 M0 23.67 C1.99 6.99, 9.33 -1.29, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(473.25 193.75684000651052) rotate(0 64.6666488647461 38.62755555555552)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "352j-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round"><g transform="translate(296.25 145.49017333984375) rotate(0 -81.5 13)"><path d="M0.98 0.88 C-26 5.25, -134.91 22.11, -162.24 26.48 M0.04 0.3 C-27.01 4.28, -135.48 20.43, -162.8 24.61" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(438.25 144.49017333984375) rotate(0 87 13.5)"><path d="M0.57 0.28 C29.47 4.7, 144.65 21.71, 173.49 26.33 M-0.59 -0.62 C28.09 3.97, 143.4 23.05, 172.28 27.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(109.25 173.49017333984375) rotate(0 261 59)"><path d="M29.5 0 C151.16 2.39, 272.88 1.32, 492.5 0 M29.5 0 C132.99 -1.75, 236.82 -1.8, 492.5 0 M492.5 0 C513.71 -1.15, 523.56 8.19, 522 29.5 M492.5 0 C510.19 -1.06, 522.16 10.9, 522 29.5 M522 29.5 C521.05 50.85, 520.64 71.74, 522 88.5 M522 29.5 C521.57 51.17, 521.19 72.86, 522 88.5 M522 88.5 C521.86 108.76, 512.16 119.1, 492.5 118 M522 88.5 C522.08 110.03, 511.9 119.89, 492.5 118 M492.5 118 C365.52 116.44, 239.27 116.73, 29.5 118 M492.5 118 C324.99 117.97, 158.18 118.36, 29.5 118 M29.5 118 C11.67 117.1, -1.79 107.76, 0 88.5 M29.5 118 C9.05 116, 1.44 107.04, 0 88.5 M0 88.5 C0.73 68.81, 2.33 53.76, 0 29.5 M0 88.5 C-1.38 72.88, -0.01 54.64, 0 29.5 M0 29.5 C1.63 9.66, 11.53 0.24, 29.5 0 M0 29.5 C1.47 12.12, 12.1 -2.01, 29.5 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></svg>

Nessa solução, o sistema de vendas coloca na fila os e-mails que precisam ser enviados, mas não aguarda o envio pela mensageria. Ao desacoplar os processos e adotar uma arquitetura orientada a eventos, temos uma série de vantagens:

* postar mensagens em um broker costumar ser uma operação simples e estável, tornando o sistema de vendas mais rápido, simples de dimensionar e escalar;

* o envio de e-mails – um processo complexo e demorado – não precisa mais ser dimensionado para o pico, apenas o broker precisa suportar o pior caso;

* apesar do broker ser uma peça a mais para manter, na prática costuma ser mais simples garantir a disponibilidade de um broker que de um sistema.

Por outro lado, temos desvantagens, especialmente pensando nas garantias de sucesso:

* o sistema de vendas não sabe quando o e-mail foi enviado, nem mesmo se houve problemas no envio;

* a observabilidade é mais difícil por envolver mais peças, especialmente erros que envolvem perda de mensagens;

* programação assíncrona é mais complexa que síncrona, esse tipo de solução costuma ser mais complexa de desenvolver.

A questão é ponderar os *trade-offs*, o exemplo da mensageria é um cenário que faz bastante sentido, mas em alguns cenários pode ser mais complexo definir a criticidade.    

Esse é um exemplo de comunicação ponta a ponta usando eventos, mas é comum existir a necessidade de mútiplos consumidores. Por exemplo, a necessidade de salvar todos os e-mails enviados em um ambiente analítico, para modelagem ou acompanhamento do time de negócios.

Como se faz para lidar com múltiplos consumidores de um mesmo evento?

# Fila ou PubSub?

O padrão para comunicação ponta-a-ponta, é utilizar uma fila: o broker mantém as mensagens guardade até que o consumidor dê um ["ack"](https://en.wikipedia.org/wiki/Acknowledgement_(data_networks)), indicando que uma mensagem específica pode ser removida.

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 747 292.49017333984375" width="700" height="300">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
      @font-face {
        font-family: "Assistant";
        src: url("https://excalidraw.com/Assistant-Regular.woff2");
      }
    </style>
    
  </defs>
  <g stroke-linecap="round" transform="translate(10 77.3233642578125) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C5.49 12.05, 14.48 6.18, 17.56 0.69 M0.5 20.31 C4.72 16.71, 8.26 11.48, 17.56 0.69 M0.64 32.35 C10.1 18.73, 21.54 7.68, 28.19 0.66 M0.64 32.35 C10.73 19.45, 22.1 8.32, 28.19 0.66 M0.77 44.4 C7.64 33.75, 17.39 23.13, 38.82 0.62 M0.77 44.4 C8.26 35.93, 17.46 25.81, 38.82 0.62 M2.22 54.93 C18.59 33.36, 36.11 14.44, 49.45 0.59 M2.22 54.93 C18.41 34.95, 36.51 16.88, 49.45 0.59 M7.6 60.93 C24.57 43.43, 37.74 24.53, 60.08 0.55 M7.6 60.93 C20.99 45.92, 33.97 31.14, 60.08 0.55 M16.92 62.41 C33.84 42.89, 52.58 22.08, 70.06 1.27 M16.92 62.41 C37.65 39.85, 55.82 16.28, 70.06 1.27 M27.55 62.37 C39.93 47.1, 52.42 33.93, 80.69 1.24 M27.55 62.37 C40.69 48.58, 52.5 35.21, 80.69 1.24 M38.18 62.34 C58.23 40.08, 74.81 17.14, 91.32 1.2 M38.18 62.34 C52.58 44.87, 68.11 27.82, 91.32 1.2 M48.81 62.3 C68.29 39.6, 92.54 14.76, 101.95 1.17 M48.81 62.3 C64.72 43.97, 80.43 26.39, 101.95 1.17 M58.78 63.02 C77.08 39.91, 96.12 19.59, 112.58 1.14 M58.78 63.02 C73.4 47.37, 87.31 29.16, 112.58 1.14 M69.41 62.99 C82.92 48.06, 95.77 30.47, 123.21 1.1 M69.41 62.99 C80.59 50.99, 91.18 37.15, 123.21 1.1 M80.04 62.95 C98.95 39.53, 118.7 16.78, 133.18 1.82 M80.04 62.95 C93.55 47.65, 105.34 32.52, 133.18 1.82 M90.67 62.92 C106.98 41.58, 123.76 23.92, 139.22 7.07 M90.67 62.92 C109.64 40.65, 128.93 20.4, 139.22 7.07 M101.3 62.88 C115 45.63, 131.5 27.55, 141.32 16.85 M101.3 62.88 C112.67 49.73, 124.52 36.94, 141.32 16.85 M111.93 62.85 C117.75 53.9, 126.35 48.94, 140.8 29.64 M111.93 62.85 C120.35 53.08, 129.67 41.04, 140.8 29.64 M121.9 63.57 C125.67 60.32, 130.13 55.06, 140.93 41.68 M121.9 63.57 C129.64 54.17, 137.04 45.69, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C40.13 1.52, 65.14 -0.14, 125.25 0 M15.75 0 C51.2 -0.26, 88.91 -0.19, 125.25 0 M125.25 0 C134.12 1.12, 141.25 6.89, 141 15.75 M125.25 0 C136.26 -1.69, 141.69 6.93, 141 15.75 M141 15.75 C141 24.88, 139.44 36.47, 141 47.25 M141 15.75 C140.22 25.6, 141.14 35.76, 141 47.25 M141 47.25 C142.45 59.18, 137.36 63.96, 125.25 63 M141 47.25 C139.34 56.32, 137.54 64.9, 125.25 63 M125.25 63 C82.11 61.53, 40.73 61.62, 15.75 63 M125.25 63 C101.15 63.47, 78.44 62.95, 15.75 63 M15.75 63 C5.15 64.94, -1.3 56.42, 0 47.25 M15.75 63 C3.46 63.9, 1.37 59.07, 0 47.25 M0 47.25 C-2 39.12, -1.7 35.33, 0 15.75 M0 47.25 C-0.07 38.88, 0.08 28.64, 0 15.75 M0 15.75 C1.46 3.59, 5.22 0.03, 15.75 0 M0 15.75 C1.95 6.47, 3.61 1.42, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(37.68000030517578 83.8233642578125) rotate(0 42.81999969482422 25)"><text x="42.81999969482422" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Sistema </text><text x="42.81999969482422" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Vendas</text></g><g stroke-linecap="round"><g transform="translate(162.0726611011055 111.73381683192997) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M-0.23 0.37 C20.03 0.44, 101.88 1.42, 122.34 1.57 M-1.82 -0.48 C18.74 0.29, 103.37 2.58, 124.49 3.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(162.0726611011055 111.73381683192997) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M100.79 11.01 C109.94 6.4, 117.77 3.75, 124.49 3.05 M100.79 11.01 C106.2 9.52, 113.43 7.67, 124.49 3.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(162.0726611011055 111.73381683192997) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M101.22 -6.09 C110.37 -4.49, 118.04 -0.92, 124.49 3.05 M101.22 -6.09 C106.65 -3.04, 113.76 -0.36, 124.49 3.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(581 178.79488118489587) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C53.98 -0.56, 83.93 2.46, 132.33 0 M23.67 0 C53.3 0.21, 82.91 -1.34, 132.33 0 M132.33 0 C148.71 1.46, 156.79 7.99, 156 23.67 M132.33 0 C149.99 -0.02, 154.21 6.07, 156 23.67 M156 23.67 C154.25 34.94, 155.81 49.39, 156 71 M156 23.67 C157.15 38.56, 155.62 51.87, 156 71 M156 71 C157.56 88.43, 149.82 93.77, 132.33 94.67 M156 71 C153.74 85.72, 147.66 94.58, 132.33 94.67 M132.33 94.67 C102.1 93.83, 70.56 94.75, 23.67 94.67 M132.33 94.67 C103.98 95.06, 76.14 96.11, 23.67 94.67 M23.67 94.67 C9.08 95.81, -1.82 88.68, 0 71 M23.67 94.67 C7.81 92.71, -1.79 85.16, 0 71 M0 71 C0.24 54.22, 1.98 37.4, 0 23.67 M0 71 C-0.36 56.32, 0.5 42.15, 0 23.67 M0 23.67 C-1.43 9.12, 7 0.22, 23.67 0 M0 23.67 C-1.72 9.54, 8.73 -0.07, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(595 188.3948811848959) rotate(0 64.66665649414062 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(580.5 81.9615478515625) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C8.82 13.11, 10.92 5.58, 16.91 1.45 M4.44 15.79 C7.37 13.72, 9.68 9.12, 16.91 1.45 M4.57 27.83 C11.42 20.91, 16.18 18.75, 27.54 1.41 M4.57 27.83 C9.4 20.88, 15.15 15.19, 27.54 1.41 M4.71 39.87 C11.97 30.96, 23.72 19.19, 38.17 1.38 M4.71 39.87 C13.48 31.05, 20.76 21.54, 38.17 1.38 M3.53 53.42 C14.52 41.91, 22.65 29.24, 48.8 1.34 M3.53 53.42 C18.84 35.42, 33.58 18.31, 48.8 1.34 M6.94 61.68 C22.49 44.24, 37.63 27.01, 59.43 1.31 M6.94 61.68 C19.89 47.64, 31.98 31.8, 59.43 1.31 M13.64 66.18 C33.49 40.37, 56.88 17.08, 70.06 1.27 M13.64 66.18 C30.43 46.85, 45.72 28.22, 70.06 1.27 M24.27 66.14 C44.98 45.25, 62.94 20.7, 80.03 1.99 M24.27 66.14 C43.41 43.61, 63.68 21.61, 80.03 1.99 M34.9 66.11 C47.43 54.93, 57.35 38.38, 90.66 1.96 M34.9 66.11 C46.75 51.8, 58.26 38.52, 90.66 1.96 M45.53 66.08 C63.65 46.32, 79.59 25.6, 101.29 1.92 M45.53 66.08 C60.93 48.01, 76.17 30.42, 101.29 1.92 M55.5 66.8 C69.11 47.61, 87.59 31.4, 111.92 1.89 M55.5 66.8 C72.47 45.12, 91.8 25.57, 111.92 1.89 M66.13 66.76 C84.33 46, 104.79 20.19, 122.55 1.86 M66.13 66.76 C80.32 50.15, 94.04 34.37, 122.55 1.86 M76.76 66.73 C93.07 48.22, 113.07 26.14, 133.18 1.82 M76.76 66.73 C91.65 52.29, 105.46 34.61, 133.18 1.82 M87.39 66.69 C106.98 46.81, 125.61 25.28, 139.22 7.07 M87.39 66.69 C100.97 49.62, 115.74 34.04, 139.22 7.07 M98.02 66.66 C111.63 49.33, 125.39 36.84, 143.29 14.58 M98.02 66.66 C111.51 51.73, 124.47 37.82, 143.29 14.58 M108.65 66.62 C115.76 54.4, 124.89 45.03, 143.42 26.62 M108.65 66.62 C118.57 56.05, 129.39 43.24, 143.42 26.62 M118.62 67.34 C125.96 59.6, 134.93 46.7, 142.9 39.42 M118.62 67.34 C127.23 57, 135.69 47.69, 142.9 39.42" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C39.71 -2.45, 65.92 -0.57, 125.25 0 M15.75 0 C57.86 1.54, 99.77 0.85, 125.25 0 M125.25 0 C137.38 -0.02, 139.44 3.67, 141 15.75 M125.25 0 C134.98 0.39, 140.27 3.15, 141 15.75 M141 15.75 C141.05 24.52, 142.39 32.01, 141 47.25 M141 15.75 C141.55 27.54, 141.63 37.24, 141 47.25 M141 47.25 C139.04 56.83, 135.36 62.93, 125.25 63 M141 47.25 C140.65 55.72, 137.91 63.84, 125.25 63 M125.25 63 C101.66 62.39, 81.82 61.19, 15.75 63 M125.25 63 C100.27 64, 73.19 64.38, 15.75 63 M15.75 63 C5.18 61.3, -1.56 56.34, 0 47.25 M15.75 63 C6.67 62.93, 1.76 58.01, 0 47.25 M0 47.25 C-0.1 38.71, -1.97 27.22, 0 15.75 M0 47.25 C-0.98 38.37, -0.71 28.37, 0 15.75 M0 15.75 C-1.5 6.68, 5.98 -0.06, 15.75 0 M0 15.75 C0.83 3.29, 3.49 -1.8, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(597.4599990844727 100.9615478515625) rotate(0 53.540000915527344 12.5)"><text x="53.540000915527344" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Mensageria</text></g><g stroke-linecap="round"><g transform="translate(448.0000000000002 114.38565787327343) rotate(0 61.64009241943421 0.7880712501122389)"><path d="M0.15 0.98 C20.9 0.99, 102.96 0.45, 123.55 0.69 M-1.23 0.45 C19.47 0.53, 102.02 1.75, 122.74 1.77" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(448.0000000000002 114.38565787327343) rotate(0 61.64009241943421 0.7880712501122389)"><path d="M99.17 10.11 C105.92 8.7, 107.96 7.04, 122.74 1.77 M99.17 10.11 C108.75 6.98, 115.94 3.09, 122.74 1.77" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(448.0000000000002 114.38565787327343) rotate(0 61.64009241943421 0.7880712501122389)"><path d="M99.32 -6.99 C106.13 -4.66, 108.14 -2.58, 122.74 1.77 M99.32 -6.99 C108.91 -3.74, 116.05 -1.25, 122.74 1.77" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(337 10) rotate(0 24.12200164794922 17.5)"><text x="0" y="24.528" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Fila</text></g><g stroke-linecap="round" transform="translate(295.75 83.99017333984375) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C6.68 15.19, 7.58 9.01, 17.56 0.69 M0.5 20.31 C4.12 16.16, 10.07 9.68, 17.56 0.69 M0.64 32.35 C6.68 23.46, 15.29 13.66, 28.19 0.66 M0.64 32.35 C10.39 22.64, 18.85 10.67, 28.19 0.66 M0.77 44.4 C11.45 31.99, 20.9 21.1, 38.82 0.62 M0.77 44.4 C9.66 33.32, 18.1 23.62, 38.82 0.62 M2.22 54.93 C16.74 35.77, 33.39 20.17, 49.45 0.59 M2.22 54.93 C16.13 38.9, 30.18 23.06, 49.45 0.59 M7.6 60.93 C28.32 37.96, 45.49 18.05, 60.08 0.55 M7.6 60.93 C22.89 43.51, 39.22 25.64, 60.08 0.55 M16.92 62.41 C29.67 44.69, 43.92 30.82, 70.06 1.27 M16.92 62.41 C33.55 43.7, 48.36 25.65, 70.06 1.27 M27.55 62.37 C41.75 45.86, 57.37 28.54, 80.69 1.24 M27.55 62.37 C45.86 42.14, 61.33 21.97, 80.69 1.24 M38.18 62.34 C56.42 39.96, 76.33 19.19, 91.32 1.2 M38.18 62.34 C53.38 44.26, 68.21 27.52, 91.32 1.2 M48.81 62.3 C58.98 48.68, 70.05 37.21, 101.95 1.17 M48.81 62.3 C68.42 40.3, 89.33 17.5, 101.95 1.17 M58.78 63.02 C74.77 43.85, 95 23.21, 112.58 1.14 M58.78 63.02 C80.12 39.75, 98.93 15.39, 112.58 1.14 M69.41 62.99 C82.23 45.81, 97.02 32.13, 123.21 1.1 M69.41 62.99 C84.06 48.33, 96.6 31.97, 123.21 1.1 M80.04 62.95 C95.16 49.35, 104.29 34.21, 133.18 1.82 M80.04 62.95 C90.88 51.15, 101.21 37.74, 133.18 1.82 M90.67 62.92 C103.38 46.9, 118.73 32.14, 139.22 7.07 M90.67 62.92 C104.14 46.32, 120.25 29, 139.22 7.07 M101.3 62.88 C110.08 53.67, 120.49 41.27, 141.32 16.85 M101.3 62.88 C115.91 44.65, 131.91 27.36, 141.32 16.85 M111.93 62.85 C124.08 52.99, 131.7 39.99, 140.8 29.64 M111.93 62.85 C119.17 55.42, 123.9 48.9, 140.8 29.64 M121.9 63.57 C128.05 55.14, 136.21 47.15, 140.93 41.68 M121.9 63.57 C125.13 58.89, 130.09 54.1, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C52.49 0.46, 86.41 1.3, 125.25 0 M15.75 0 C48.17 1.03, 80.94 -0.05, 125.25 0 M125.25 0 C134.4 -0.27, 141.48 5.34, 141 15.75 M125.25 0 C137.42 1.65, 142.85 6.36, 141 15.75 M141 15.75 C142.46 24.64, 139.91 28.14, 141 47.25 M141 15.75 C140.79 22.87, 141.88 32.13, 141 47.25 M141 47.25 C139.14 57.9, 134.82 62.1, 125.25 63 M141 47.25 C140.89 59.98, 134.25 61.47, 125.25 63 M125.25 63 C102.07 61.83, 78.5 63.59, 15.75 63 M125.25 63 C102.35 62.2, 78.98 62.34, 15.75 63 M15.75 63 C5.6 64.97, 0.65 57.96, 0 47.25 M15.75 63 C6.93 61.09, -0.04 57.78, 0 47.25 M0 47.25 C1.07 34.25, 0.05 21.52, 0 15.75 M0 47.25 C0.25 34.69, -0.88 23.05, 0 15.75 M0 15.75 C1.14 6.81, 6.46 -0.03, 15.75 0 M0 15.75 C-1.61 6.41, 3.84 -1.3, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(320.11000061035156 90.49017333984375) rotate(0 46.13999938964844 25)"><text x="46.13999938964844" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Message </text><text x="46.13999938964844" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Brocker</text></g><g stroke-linecap="round" transform="translate(374.25 179.15684000651038) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C60.54 -2.45, 95.86 -1.55, 132.33 0 M23.67 0 C57.43 0.86, 92.79 1.04, 132.33 0 M132.33 0 C149.56 1.43, 157.61 8.85, 156 23.67 M132.33 0 C146.45 -1.43, 157.79 9.79, 156 23.67 M156 23.67 C154.87 41.53, 155.71 59.87, 156 71 M156 23.67 C155.52 33.76, 155.98 43.25, 156 71 M156 71 C155.9 88.72, 146.81 93.34, 132.33 94.67 M156 71 C154.21 87.68, 149.48 95.99, 132.33 94.67 M132.33 94.67 C107.94 93.07, 85.56 95.87, 23.67 94.67 M132.33 94.67 C100.24 95.77, 68.12 94.89, 23.67 94.67 M23.67 94.67 C9.35 93.01, -0.03 86.81, 0 71 M23.67 94.67 C9.84 95.89, -1.64 88.2, 0 71 M0 71 C1.38 59.62, -0.11 47.51, 0 23.67 M0 71 C0.93 61.61, 0.97 50.65, 0 23.67 M0 23.67 C-1.4 8.9, 6.66 -1.13, 23.67 0 M0 23.67 C-1.28 6.18, 10.08 -0.55, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(388.25 188.7568400065104) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 3}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(208.25 180.15684000651038) rotate(0 78 47.333333333333314)"><path d="M23.67 0 C48.13 -0.27, 70.09 -0.99, 132.33 0 M23.67 0 C55.55 0.67, 86.78 0.43, 132.33 0 M132.33 0 C146.67 -1.24, 157.56 9.54, 156 23.67 M132.33 0 C150.08 -1.03, 153.74 6.83, 156 23.67 M156 23.67 C154.21 38.82, 156.71 48.36, 156 71 M156 23.67 C155.73 39.19, 155.13 52.11, 156 71 M156 71 C154.44 87.56, 149.3 95.81, 132.33 94.67 M156 71 C153.9 88.96, 148.04 92.71, 132.33 94.67 M132.33 94.67 C108.13 96.87, 84.28 95.69, 23.67 94.67 M132.33 94.67 C89.76 93.95, 45.71 94.79, 23.67 94.67 M23.67 94.67 C9.58 95.73, -1.43 88.01, 0 71 M23.67 94.67 C6.87 94.92, -1.72 88.43, 0 71 M0 71 C-1.69 53.54, -1.55 40.29, 0 23.67 M0 71 C-0.99 53.62, -0.9 34.67, 0 23.67 M0 23.67 C-1.11 6.4, 9.79 -0.48, 23.67 0 M0 23.67 C-1.47 7.88, 5.92 0.44, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(222.25 189.75684000651052) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "352j-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round"><g transform="translate(296.25 141.49017333984375) rotate(0 -51 12)"><path d="M-0.81 -0.16 C-17.7 4.03, -84.99 19.88, -101.71 24.05 M0.96 -1.29 C-16.02 3.21, -85.45 21.58, -102.51 25.62" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(438.25 140.49017333984375) rotate(0 48.5 13)"><path d="M0.29 0.05 C16.73 4.56, 81.59 22.44, 97.87 26.86 M-1.02 -0.96 C15.41 3.22, 80.92 20.94, 97.38 25.19" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(192.25 164.49017333984375) rotate(0 176.5 59)"><path d="M29.5 0 C125.76 -0.39, 220.6 -2.66, 323.5 0 M29.5 0 C100.1 -2.14, 168.7 -2.15, 323.5 0 M323.5 0 C342.78 -0.07, 352.7 8.07, 353 29.5 M323.5 0 C345.32 0.84, 350.86 10.01, 353 29.5 M353 29.5 C354.68 43.15, 351.41 57.85, 353 88.5 M353 29.5 C352.44 50.45, 353.32 68.66, 353 88.5 M353 88.5 C351.44 106.76, 344.4 117.94, 323.5 118 M353 88.5 C354.76 108.42, 343.57 120.27, 323.5 118 M323.5 118 C224.5 119.57, 127.98 120.85, 29.5 118 M323.5 118 C219.34 119.43, 115.29 119.88, 29.5 118 M29.5 118 C10.56 117.94, 0.72 106.46, 0 88.5 M29.5 118 C8.07 116.2, 1.31 109.96, 0 88.5 M0 88.5 C1.02 66, -1.12 44.83, 0 29.5 M0 88.5 C-1.2 75.18, -1.42 62.07, 0 29.5 M0 29.5 C1.75 9.25, 10.39 1.96, 29.5 0 M0 29.5 C-1.63 8.51, 7.84 -1.34, 29.5 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></svg>

O problema é que esse padrão não suporta múltiplos consumidores, a não ser que sejam criadas filas independentes e o produtor multiplique as mensagens. Não é uma solução escalável, já que a quantidade de mensagens cresce em função do número de consumidores.

A alternativa, para lidar com um cenário de múltiplos consumidores, é utilizar a abordagem PubSub adotada pelo Kafka. Nesse modelo, o broker guarda o conteúdo por um tempo determinado (*e.g.* 7 dias), cada consumidor controlar o *offset* para saber o que já consumiram.

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 730.75 436.1158744154561" width="700" height="400">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face {
        font-family: "Virgil";
        src: url("https://excalidraw.com/Virgil.woff2");
      }
      @font-face {
        font-family: "Cascadia";
        src: url("https://excalidraw.com/Cascadia.woff2");
      }
      @font-face {
        font-family: "Assistant";
        src: url("https://excalidraw.com/Assistant-Regular.woff2");
      }
    </style>
    
  </defs>
  <g transform="translate(312 25.64324951171875) rotate(0 47.89399719238281 17.5)"><text x="0" y="24.528" font-family="Virgil, Segoe UI Emoji" font-size="28px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">PubSub</text></g><g stroke-linecap="round" transform="translate(18.75 143.36181640625) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C8.54 12.28, 11.23 6.31, 16.91 1.45 M4.44 15.79 C9.17 9.86, 14.25 4.52, 16.91 1.45 M4.57 27.83 C13.71 18.12, 21.56 9.69, 27.54 1.41 M4.57 27.83 C14.02 17.07, 22.97 7.72, 27.54 1.41 M4.71 39.87 C15 24.24, 29.79 11.02, 38.17 1.38 M4.71 39.87 C14.4 27.7, 25.64 16.27, 38.17 1.38 M3.53 53.42 C14.14 41.15, 21.94 31.71, 48.8 1.34 M3.53 53.42 C20.79 34.11, 37.87 14.55, 48.8 1.34 M6.94 61.68 C19.83 46.69, 33.21 28.82, 59.43 1.31 M6.94 61.68 C23.42 42.63, 38.26 24.09, 59.43 1.31 M13.64 66.18 C32.78 41.53, 51.07 19.29, 70.06 1.27 M13.64 66.18 C34 43.1, 53.43 20.38, 70.06 1.27 M24.27 66.14 C46.98 39.14, 67.95 14.91, 80.03 1.99 M24.27 66.14 C40.14 47.63, 55.04 28.76, 80.03 1.99 M34.9 66.11 C47.1 51.31, 61.53 37.8, 90.66 1.96 M34.9 66.11 C55.1 44.63, 73.33 20.86, 90.66 1.96 M45.53 66.08 C63.14 47.62, 79.05 24.48, 101.29 1.92 M45.53 66.08 C66.15 40.97, 88.46 15.53, 101.29 1.92 M55.5 66.8 C72.06 46.11, 88.67 26.61, 111.92 1.89 M55.5 66.8 C78.28 42.06, 98.87 17.25, 111.92 1.89 M66.13 66.76 C81.76 52.25, 94.85 33.06, 122.55 1.86 M66.13 66.76 C78 52.55, 91.51 38.81, 122.55 1.86 M76.76 66.73 C91.58 51.58, 106.62 32.54, 133.18 1.82 M76.76 66.73 C100.56 41.67, 122.55 14.62, 133.18 1.82 M87.39 66.69 C107.12 44.9, 124.16 23.53, 139.22 7.07 M87.39 66.69 C98.48 54.69, 109.2 40.9, 139.22 7.07 M98.02 66.66 C114.06 47.9, 130.55 27.72, 143.29 14.58 M98.02 66.66 C110.09 51.48, 123.75 36.86, 143.29 14.58 M108.65 66.62 C117 55.74, 128.22 42.24, 143.42 26.62 M108.65 66.62 C117.84 54.77, 128.49 43.54, 143.42 26.62 M118.62 67.34 C124.4 58.75, 131.49 52.53, 142.9 39.42 M118.62 67.34 C126.07 60.3, 132.57 51.55, 142.9 39.42" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C49.77 -1.97, 89.43 0.48, 125.25 0 M15.75 0 C41.85 -1.51, 65.5 -0.67, 125.25 0 M125.25 0 C137.5 -0.35, 139.27 4.9, 141 15.75 M125.25 0 C136.72 -2.2, 141.04 3.73, 141 15.75 M141 15.75 C140.01 21.68, 140.85 29.25, 141 47.25 M141 15.75 C140.4 26.78, 140.26 37.62, 141 47.25 M141 47.25 C142.34 57.62, 134.39 63.99, 125.25 63 M141 47.25 C141.88 56.73, 135.65 64.32, 125.25 63 M125.25 63 C91.28 62.25, 58.55 63.74, 15.75 63 M125.25 63 C83.53 63.65, 41.73 63.41, 15.75 63 M15.75 63 C4.13 62.24, -1.26 58.97, 0 47.25 M15.75 63 C7.45 60.71, -0.74 58.4, 0 47.25 M0 47.25 C-1.04 35.6, 0.31 24.16, 0 15.75 M0 47.25 C0.2 40.18, 0.32 32.72, 0 15.75 M0 15.75 C-0.08 5.89, 4.12 -1.2, 15.75 0 M0 15.75 C-0.36 3.45, 6.7 -0.7, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(46.43000030517578 149.86181640625) rotate(0 42.81999969482422 25)"><text x="42.81999969482422" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Sistema </text><text x="42.81999969482422" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Vendas</text></g><g stroke-linecap="round"><g transform="translate(170.8226611011055 177.77226898036747) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M0.5 -0.85 C21.29 -0.58, 103.08 2.37, 123.75 2.67 M-0.7 1.32 C20.05 1.79, 102.14 0.98, 122.99 1.07" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(170.8226611011055 177.77226898036747) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M99.53 9.7 C103.17 8.31, 111.38 7.79, 122.99 1.07 M99.53 9.7 C106.09 7.39, 110 5.31, 122.99 1.07" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(170.8226611011055 177.77226898036747) rotate(0 61.69805502204872 0.8341756103390026)"><path d="M99.48 -7.4 C103.28 -5.05, 111.49 -1.84, 122.99 1.07 M99.48 -7.4 C105.97 -5.6, 109.89 -3.56, 122.99 1.07" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(201.75 248.83333333333348) rotate(0 78 47.33333333333337)"><path d="M23.67 0 C62.43 1.63, 96.67 -1.32, 132.33 0 M23.67 0 C58.04 0.02, 94.56 -0.77, 132.33 0 M132.33 0 C148.15 -1.32, 154.85 7.05, 156 23.67 M132.33 0 C146.79 -0.99, 154.04 7.87, 156 23.67 M156 23.67 C157.89 32.27, 157.17 41.99, 156 71 M156 23.67 C155.64 42.23, 156.7 59.35, 156 71 M156 71 C155.91 87.93, 148.23 93.28, 132.33 94.67 M156 71 C155.25 86.25, 147.66 95.05, 132.33 94.67 M132.33 94.67 C94.04 95.12, 56.21 95.23, 23.67 94.67 M132.33 94.67 C96.26 94.86, 62.4 93.26, 23.67 94.67 M23.67 94.67 C7.25 95.23, 1.26 85.83, 0 71 M23.67 94.67 C6.85 93.3, -0.25 86.97, 0 71 M0 71 C-0.4 57.47, -0.17 44.02, 0 23.67 M0 71 C-0.55 60.73, -0.14 50.87, 0 23.67 M0 23.67 C1.26 7.28, 8.91 -0.59, 23.67 0 M0 23.67 C1.27 10.15, 6.09 0.22, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(215.75 258.4333333333334) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(459.25 10) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C6.97 12, 10.51 8.74, 16.91 1.45 M4.44 15.79 C8.86 11.33, 14.08 5.29, 16.91 1.45 M4.57 27.83 C14.03 19.47, 22.46 9.54, 27.54 1.41 M4.57 27.83 C9.35 22.49, 14.26 16.59, 27.54 1.41 M4.71 39.87 C13.01 27.92, 23.05 19.82, 38.17 1.38 M4.71 39.87 C17.47 26.21, 30.01 11.16, 38.17 1.38 M3.53 53.42 C18.3 37.65, 28.63 24.65, 48.8 1.34 M3.53 53.42 C13.56 41.69, 25.12 28.88, 48.8 1.34 M6.94 61.68 C25.6 40.69, 47.49 17.99, 59.43 1.31 M6.94 61.68 C22 45.24, 37.37 26.68, 59.43 1.31 M13.64 66.18 C31.71 46.27, 53.62 21.18, 70.06 1.27 M13.64 66.18 C33.69 43.44, 54.21 20.99, 70.06 1.27 M24.27 66.14 C41.58 43.55, 62.38 22.02, 80.03 1.99 M24.27 66.14 C40.24 48.6, 55.3 29.9, 80.03 1.99 M34.9 66.11 C53.97 43.06, 76.2 19.11, 90.66 1.96 M34.9 66.11 C51.48 46.76, 70.85 26.19, 90.66 1.96 M45.53 66.08 C58.61 50.24, 74.04 32.34, 101.29 1.92 M45.53 66.08 C60.42 50.47, 74.41 32.19, 101.29 1.92 M55.5 66.8 C75.77 42.76, 95.72 20.65, 111.92 1.89 M55.5 66.8 C75.16 41.91, 95.63 19.77, 111.92 1.89 M66.13 66.76 C78.9 52.4, 90.77 37.99, 122.55 1.86 M66.13 66.76 C83.49 46.85, 100.82 25.38, 122.55 1.86 M76.76 66.73 C96.97 42.86, 119.8 15.49, 133.18 1.82 M76.76 66.73 C97.18 42.33, 118.55 18.59, 133.18 1.82 M87.39 66.69 C102.43 49.56, 117.85 29.11, 139.22 7.07 M87.39 66.69 C100.26 51.17, 114.55 35.21, 139.22 7.07 M98.02 66.66 C107.65 55.2, 118.1 42.62, 143.29 14.58 M98.02 66.66 C107.09 55.05, 118.72 42.92, 143.29 14.58 M108.65 66.62 C116.8 55.39, 128.15 45.29, 143.42 26.62 M108.65 66.62 C118 56.6, 126.57 45.8, 143.42 26.62 M118.62 67.34 C127.36 59.6, 133.84 47.2, 142.9 39.42 M118.62 67.34 C125.1 59.28, 132.1 51.24, 142.9 39.42" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C59.81 2.29, 102.56 -1.18, 125.25 0 M15.75 0 C46.7 0.39, 77.04 0.63, 125.25 0 M125.25 0 C134.6 -0.86, 139.29 5.23, 141 15.75 M125.25 0 C133.71 0.79, 141.74 7.24, 141 15.75 M141 15.75 C142.79 24.33, 141.03 28.87, 141 47.25 M141 15.75 C141.08 27.33, 141.18 37.06, 141 47.25 M141 47.25 C140.35 57.29, 135.35 63.33, 125.25 63 M141 47.25 C142.26 59.64, 136.14 63.32, 125.25 63 M125.25 63 C91.47 62.09, 55.88 61.95, 15.75 63 M125.25 63 C85.41 62.19, 46.84 61.44, 15.75 63 M15.75 63 C4.35 61.82, -0.22 57.92, 0 47.25 M15.75 63 C5 61.06, -0.86 56.83, 0 47.25 M0 47.25 C-1.82 37.47, 0.73 26.71, 0 15.75 M0 47.25 C0.68 39.38, 0.56 31.83, 0 15.75 M0 15.75 C1.1 7.22, 3.68 0.19, 15.75 0 M0 15.75 C-1.29 6.06, 4.51 -0.58, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(476.20999908447266 29) rotate(0 53.540000915527344 12.5)"><text x="53.540000915527344" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Mensageria</text></g><g stroke-linecap="round"><g transform="translate(410.64465824041633 145.77862548828102) rotate(0 39.64458462645297 -31.779405163574836)"><path d="M-1.04 -0.21 C12.09 -10.96, 66.4 -54.02, 79.8 -64.71 M0.62 -1.37 C13.54 -11.99, 66.12 -53.43, 79.11 -63.78" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(410.64465824041633 145.77862548828102) rotate(0 39.64458462645297 -31.779405163574836)"><path d="M66.01 -42.49 C70.77 -49.77, 74.28 -58.83, 79.11 -63.78 M66.01 -42.49 C68.62 -47.84, 71.41 -52.39, 79.11 -63.78" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(410.64465824041633 145.77862548828102) rotate(0 39.64458462645297 -31.779405163574836)"><path d="M55.39 -55.89 C64.24 -57.89, 71.86 -61.76, 79.11 -63.78 M55.39 -55.89 C60.41 -58.06, 65.68 -59.48, 79.11 -63.78" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(304.5 150.02862548828125) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M0.5 20.31 C8.51 12.38, 15.49 6.16, 17.56 0.69 M0.5 20.31 C6.18 14.94, 11.4 9.04, 17.56 0.69 M0.64 32.35 C11.19 21.15, 20.73 10.35, 28.19 0.66 M0.64 32.35 C8.25 24.33, 13.63 17.12, 28.19 0.66 M0.77 44.4 C11.64 31.54, 24.51 18.55, 38.82 0.62 M0.77 44.4 C12.85 30.93, 25.09 15.33, 38.82 0.62 M2.22 54.93 C18.41 33.79, 38.09 15.33, 49.45 0.59 M2.22 54.93 C12.99 41.07, 25.97 28.7, 49.45 0.59 M7.6 60.93 C23.44 40.07, 43.69 20.39, 60.08 0.55 M7.6 60.93 C19.74 46.42, 33.03 33.68, 60.08 0.55 M16.92 62.41 C28.96 47.91, 41.54 35.05, 70.06 1.27 M16.92 62.41 C32.29 43.06, 48.47 25.41, 70.06 1.27 M27.55 62.37 C41.09 49.21, 53.25 34.36, 80.69 1.24 M27.55 62.37 C40 45.91, 54.28 31.2, 80.69 1.24 M38.18 62.34 C52.77 42.19, 71.46 27.04, 91.32 1.2 M38.18 62.34 C59.02 38.46, 79.33 15.81, 91.32 1.2 M48.81 62.3 C58.76 49.19, 73.54 34.62, 101.95 1.17 M48.81 62.3 C61.09 47.24, 74.19 31.99, 101.95 1.17 M58.78 63.02 C75.37 42.21, 90.01 22.35, 112.58 1.14 M58.78 63.02 C81.08 38.93, 101.69 14.47, 112.58 1.14 M69.41 62.99 C81.43 48.86, 94.51 34.06, 123.21 1.1 M69.41 62.99 C86.77 42.02, 104.43 22.56, 123.21 1.1 M80.04 62.95 C91.66 48.28, 102.52 35.8, 133.18 1.82 M80.04 62.95 C90.55 49.65, 102.57 36.64, 133.18 1.82 M90.67 62.92 C103.27 46.55, 116.74 33.05, 139.22 7.07 M90.67 62.92 C102.98 49.17, 114.97 35.71, 139.22 7.07 M101.3 62.88 C110.2 50.92, 119.06 43.96, 141.32 16.85 M101.3 62.88 C110.77 52.33, 118.91 43.2, 141.32 16.85 M111.93 62.85 C120.35 53.56, 129.87 42.86, 140.8 29.64 M111.93 62.85 C117.93 55.66, 125.31 47.48, 140.8 29.64 M121.9 63.57 C128.21 56.8, 132.34 50.79, 140.93 41.68 M121.9 63.57 C129.92 55.09, 136.66 47.43, 140.93 41.68" stroke="#a5d8ff" stroke-width="1" fill="none"></path><path d="M15.75 0 C37.23 -0.43, 61.21 -1.61, 125.25 0 M15.75 0 C43.14 0.46, 71.35 0.81, 125.25 0 M125.25 0 C136.4 1.73, 139.6 6.26, 141 15.75 M125.25 0 C133.81 1.88, 142.54 5.1, 141 15.75 M141 15.75 C140.27 22.97, 142.3 30.49, 141 47.25 M141 15.75 C140.7 23.18, 141.45 31.11, 141 47.25 M141 47.25 C141.34 58.02, 136.02 64.01, 125.25 63 M141 47.25 C141.44 58.35, 134.46 62.13, 125.25 63 M125.25 63 C97.29 63.4, 73.86 65.31, 15.75 63 M125.25 63 C97.46 62.43, 69.79 61.51, 15.75 63 M15.75 63 C4.51 62.2, 0.16 57.18, 0 47.25 M15.75 63 C5.71 60.8, -0.09 58.48, 0 47.25 M0 47.25 C-1.38 40.84, -0.42 32.94, 0 15.75 M0 47.25 C-0.96 38.83, -0.74 30.57, 0 15.75 M0 15.75 C-0.65 4.74, 7.23 1.82, 15.75 0 M0 15.75 C0.18 3.03, 6.12 -0.43, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(328.86000061035156 156.52862548828125) rotate(0 46.13999938964844 25)"><text x="46.13999938964844" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Message </text><text x="46.13999938964844" y="42.519999999999996" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Brocker</text></g><g stroke-linecap="round" transform="translate(369 247.19529215494777) rotate(0 78 47.33333333333337)"><path d="M23.67 0 C55.62 -0.52, 88.39 -1.08, 132.33 0 M23.67 0 C56.5 0.49, 87.99 0.13, 132.33 0 M132.33 0 C146.42 1.63, 157.34 7.76, 156 23.67 M132.33 0 C146.55 1.13, 156.88 6.87, 156 23.67 M156 23.67 C154.89 37.01, 155.81 51.26, 156 71 M156 23.67 C156.43 38.78, 156.39 54.13, 156 71 M156 71 C156.38 87.3, 146.99 93.91, 132.33 94.67 M156 71 C154.56 88.18, 150.31 92.38, 132.33 94.67 M132.33 94.67 C102.28 94.45, 72.93 95.14, 23.67 94.67 M132.33 94.67 C98.46 93.35, 65.41 93.46, 23.67 94.67 M23.67 94.67 C8.29 92.75, -0.08 87.41, 0 71 M23.67 94.67 C6.59 93.29, -0.36 84.98, 0 71 M0 71 C-0.45 54.93, 2.11 35.08, 0 23.67 M0 71 C-0.06 56.09, 1.25 42.6, 0 23.67 M0 23.67 C0.16 5.96, 8.64 -0.37, 23.67 0 M0 23.67 C-2.11 6.46, 8.45 0.55, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(383 256.7952921549479) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 3}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round" transform="translate(538 246.19529215494777) rotate(0 78 47.33333333333337)"><path d="M23.67 0 C50.02 -0.85, 77.09 1.57, 132.33 0 M23.67 0 C64.83 0.27, 108.35 -0.61, 132.33 0 M132.33 0 C146.75 0.99, 156.76 7, 156 23.67 M132.33 0 C148.01 1.32, 156.14 6.3, 156 23.67 M156 23.67 C156.22 37.42, 157.54 49.31, 156 71 M156 23.67 C156.25 38.78, 155.5 52.98, 156 71 M156 71 C154.74 88, 150.02 92.68, 132.33 94.67 M156 71 C155.26 87.42, 149.56 93.58, 132.33 94.67 M132.33 94.67 C104.79 94.33, 75.22 93.8, 23.67 94.67 M132.33 94.67 C104.26 93.4, 75.75 94.68, 23.67 94.67 M23.67 94.67 C6.76 93.47, -0.31 85.21, 0 71 M23.67 94.67 C9.34 93.97, 1.18 86.1, 0 71 M0 71 C-0.27 53.06, 0.23 36.73, 0 23.67 M0 71 C-0.39 57.04, -0.09 44.82, 0 23.67 M0 23.67 C-1.84 6.65, 8.38 0.48, 23.67 0 M0 23.67 C-0.43 6.09, 9.5 -1.39, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(552 255.79529215494813) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "352j-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g stroke-linecap="round"><g transform="translate(305 207.52862548828125) rotate(0 -139.5 15.5)"><path d="M0.39 1.04 C-46.08 6.24, -233.11 26.45, -279.84 31.6 M-0.87 0.54 C-46.86 5.35, -231.44 24.86, -277.57 29.8" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(447 206.52862548828125) rotate(0 119 14.5)"><path d="M-0.84 0.6 C38.59 5.43, 197.05 25.26, 236.99 29.98 M0.92 -0.13 C40.68 4.9, 199.58 23.32, 239.17 28.37" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(10 235.52862548828125) rotate(0 351 59)"><path d="M29.5 0 C177.94 2.7, 325.03 1.63, 672.5 0 M29.5 0 C254.09 1.37, 478.74 0.86, 672.5 0 M672.5 0 C691.51 -0.46, 701.6 10.16, 702 29.5 M672.5 0 C693.43 1.89, 702.39 10.15, 702 29.5 M702 29.5 C702.82 46.86, 701.54 65.21, 702 88.5 M702 29.5 C702.24 51.08, 703.19 71.62, 702 88.5 M702 88.5 C701.1 106.98, 691.95 118.17, 672.5 118 M702 88.5 C701.75 106.22, 691.31 117.08, 672.5 118 M672.5 118 C473.66 118.48, 276.6 118.06, 29.5 118 M672.5 118 C518.38 115.87, 363.95 115.87, 29.5 118 M29.5 118 C10.94 119.97, -1.57 108.36, 0 88.5 M29.5 118 C8.54 118.81, -0.74 107.58, 0 88.5 M0 88.5 C-2.47 65.73, -0.91 39.61, 0 29.5 M0 88.5 C-0.33 73.69, 0.56 59.83, 0 29.5 M0 29.5 C-0.28 9.9, 8.48 1.05, 29.5 0 M0 29.5 C-1.63 10.59, 7.91 2.08, 29.5 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g stroke-linecap="round" transform="translate(563.015380859375 112.93130493164062) rotate(0 70.5 31.5)"><path d="M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M2.34 6.01 C2.34 6.01, 2.34 6.01, 2.34 6.01 M4.44 15.79 C10.18 11.82, 12.21 4.06, 16.91 1.45 M4.44 15.79 C8.72 12.93, 10.43 8.76, 16.91 1.45 M4.57 27.83 C8.45 22.17, 14.33 16.06, 27.54 1.41 M4.57 27.83 C11.77 18.55, 21.34 9.67, 27.54 1.41 M4.71 39.87 C14.1 30.84, 24.1 21.65, 38.17 1.38 M4.71 39.87 C11.2 30.16, 18.86 22.06, 38.17 1.38 M3.53 53.42 C20.86 32.97, 35.56 16.43, 48.8 1.34 M3.53 53.42 C16.9 37.91, 28.52 24.54, 48.8 1.34 M6.94 61.68 C26.06 40.02, 46.95 18.98, 59.43 1.31 M6.94 61.68 C25.59 39.44, 44.12 17.51, 59.43 1.31 M13.64 66.18 C31.81 42.83, 50.06 23.2, 70.06 1.27 M13.64 66.18 C24.13 52.93, 35.77 40.09, 70.06 1.27 M24.27 66.14 C39.18 50.56, 51.8 35.72, 80.03 1.99 M24.27 66.14 C38.13 50.29, 51.03 33.79, 80.03 1.99 M34.9 66.11 C53.23 44.59, 67.73 26.17, 90.66 1.96 M34.9 66.11 C54.86 43.95, 75.7 19.31, 90.66 1.96 M45.53 66.08 C64.15 41.8, 86.2 21.7, 101.29 1.92 M45.53 66.08 C58.42 50.05, 72.64 33.77, 101.29 1.92 M55.5 66.8 C74.93 42.57, 96.88 17.11, 111.92 1.89 M55.5 66.8 C73.01 45.63, 92.42 24.2, 111.92 1.89 M66.13 66.76 C77.24 52.17, 91.06 38.22, 122.55 1.86 M66.13 66.76 C85.49 44.44, 104.36 23.09, 122.55 1.86 M76.76 66.73 C98.38 41.42, 120.02 16.5, 133.18 1.82 M76.76 66.73 C94.74 46.15, 112.44 24.86, 133.18 1.82 M87.39 66.69 C104.52 45.93, 122.31 22.85, 139.22 7.07 M87.39 66.69 C102.69 50.6, 116.71 32.13, 139.22 7.07 M98.02 66.66 C112.04 50.17, 126.1 32.98, 143.29 14.58 M98.02 66.66 C110.12 51.1, 124.16 35.69, 143.29 14.58 M108.65 66.62 C123.08 53.24, 134.48 35.71, 143.42 26.62 M108.65 66.62 C119.07 56.09, 127.57 44.64, 143.42 26.62 M118.62 67.34 C126.85 58.55, 135.97 48.66, 142.9 39.42 M118.62 67.34 C126.61 59.46, 133.19 51.3, 142.9 39.42" stroke="#b2f2bb" stroke-width="1" fill="none"></path><path d="M15.75 0 C46.28 -0.52, 79.88 1.02, 125.25 0 M15.75 0 C59.54 -0.38, 102.63 0.49, 125.25 0 M125.25 0 C134.17 1.81, 142.75 4.22, 141 15.75 M125.25 0 C135.78 0.27, 141.41 6.32, 141 15.75 M141 15.75 C141.81 24.9, 140.58 31.93, 141 47.25 M141 15.75 C141.82 27.14, 141.31 38.47, 141 47.25 M141 47.25 C139.44 58.12, 136.65 62.98, 125.25 63 M141 47.25 C142.74 55.5, 133.95 64.17, 125.25 63 M125.25 63 C102.1 62.14, 81.88 61.07, 15.75 63 M125.25 63 C100.11 62.04, 75.75 63.88, 15.75 63 M15.75 63 C7.03 62.55, -0.84 58.99, 0 47.25 M15.75 63 C4.98 62.95, 1.89 55.93, 0 47.25 M0 47.25 C-1.84 33.2, -0.35 24.44, 0 15.75 M0 47.25 C-0.69 35.18, -1.17 22.07, 0 15.75 M0 15.75 C0.17 6.08, 5.97 0.49, 15.75 0 M0 15.75 C1.17 5.63, 5.16 0.53, 15.75 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(590.0053825378418 131.93130493164062) rotate(0 43.5099983215332 12.5)"><text x="43.5099983215332" y="17.52" font-family="Virgil, Segoe UI Emoji" font-size="20px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Analytics</text></g><g stroke-linecap="round"><g transform="translate(449.515380859375 169.2697681584525) rotate(0 54 -4.803119436582733)"><path d="M0.6 -0.24 C18.41 -1.92, 89.8 -8.68, 107.57 -10.16 M-0.54 -1.42 C17.02 -2.92, 88.03 -7.27, 106.39 -8.92" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(449.515380859375 169.2697681584525) rotate(0 54 -4.803119436582733)"><path d="M83.59 1.34 C91.36 -3.17, 99 -7.48, 106.39 -8.92 M83.59 1.34 C91.07 -2.82, 98.37 -5.16, 106.39 -8.92" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(449.515380859375 169.2697681584525) rotate(0 54 -4.803119436582733)"><path d="M82.33 -15.71 C90.53 -14.12, 98.62 -12.33, 106.39 -8.92 M82.33 -15.71 C90.39 -14.14, 98.12 -10.73, 106.39 -8.92" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(181.515380859375 404.8078161104661) rotate(0 98.84110260009766 10.654029152495013)"><text x="0" y="17.146328167296705" font-family="Cascadia, Segoe UI Emoji" font-size="17.7567152541584px" fill="#1971c2" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">offset:mensageria:2</text></g><g stroke-linecap="round" transform="translate(26.515380859375 248.72248331705714) rotate(0 78 47.33333333333337)"><path d="M23.67 0 C53.41 0.57, 85.11 -1.62, 132.33 0 M23.67 0 C63.28 -0.32, 100.62 0.95, 132.33 0 M132.33 0 C149.81 1.68, 154.72 6.59, 156 23.67 M132.33 0 C147.19 0.63, 157.2 8.81, 156 23.67 M156 23.67 C157.52 35.15, 157.69 44.59, 156 71 M156 23.67 C155.63 38.58, 157.16 52.25, 156 71 M156 71 C156.96 87.25, 146.45 95.21, 132.33 94.67 M156 71 C155.01 87.6, 148.04 94.76, 132.33 94.67 M132.33 94.67 C97.47 92.47, 63.04 95.62, 23.67 94.67 M132.33 94.67 C97.19 95.89, 62.46 94.29, 23.67 94.67 M23.67 94.67 C8.86 95.97, -1.75 87.66, 0 71 M23.67 94.67 C8.63 92.56, 0.31 85.52, 0 71 M0 71 C1.98 60.38, -1.73 47.41, 0 23.67 M0 71 C-0.46 60.58, -1.01 51.25, 0 23.67 M0 23.67 C-0.12 7.35, 7.56 -1.4, 23.67 0 M0 23.67 C1.87 7.64, 5.91 0.58, 23.67 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(40.515380859375 258.32248331705705) rotate(0 64.6666488647461 38.627555555555546)"><text x="0" y="8.880888888888883" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{message_id: "fsd3-..."</text><text x="0" y="19.917333333333318" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> client_id:: "a324-...",</text><text x="0" y="30.953777777777756" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> products: [</text><text x="0" y="41.990222222222194" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    {sku: "231",</text><text x="0" y="53.02666666666663" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">     quantity: 1}</text><text x="0" y="64.06311111111106" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    ...]</text><text x="0" y="75.0995555555555" font-family="Cascadia, Segoe UI Emoji" font-size="9.197037037037031px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"> address:}</text></g><g transform="translate(533.4721221923828 404.4017874978956) rotate(0 93.6389389038086 10.654029152495013)"><text x="0" y="17.146328167296705" font-family="Cascadia, Segoe UI Emoji" font-size="17.7567152541584px" fill="#2f9e44" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">offset:analytics:4</text></g><g stroke-linecap="round"><g transform="translate(619.9688361510687 341.52862548828125) rotate(0 -0.1594167865938516 25.763595581054688)"><path d="M1.09 0.02 C0.77 8.91, -0.85 44, -1 52.59" stroke="#2f9e44" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8"></path></g><g transform="translate(619.9688361510687 341.52862548828125) rotate(0 -0.1594167865938516 25.763595581054688)"><path d="M-8.75 28.82 C-5.97 36.53, -1.32 47.44, -1 52.59" stroke="#2f9e44" stroke-width="2.5" fill="none" stroke-dasharray="1.5 6"></path></g><g transform="translate(619.9688361510687 341.52862548828125) rotate(0 -0.1594167865938516 25.763595581054688)"><path d="M8.34 29.4 C4.72 37.04, 2.96 47.74, -1 52.59" stroke="#2f9e44" stroke-width="2.5" fill="none" stroke-dasharray="1.5 6"></path></g></g><mask></mask><g stroke-linecap="round"><g transform="translate(276.515380859375 344.0558166503906) rotate(0 0.5 28.5)"><path d="M0.45 0.77 C0.37 10.42, 0.15 48.27, 0.04 57.84" stroke="#1971c2" stroke-width="2.5" fill="none" stroke-dasharray="1.5 8"></path></g><g transform="translate(276.515380859375 344.0558166503906) rotate(0 0.5 28.5)"><path d="M-8.32 34.28 C-4.17 40.72, -1.21 48.45, 0.04 57.84" stroke="#1971c2" stroke-width="2.5" fill="none" stroke-dasharray="1.5 6"></path></g><g transform="translate(276.515380859375 344.0558166503906) rotate(0 0.5 28.5)"><path d="M8.78 34.41 C7.07 40.88, 4.18 48.55, 0.04 57.84" stroke="#1971c2" stroke-width="2.5" fill="none" stroke-dasharray="1.5 6"></path></g></g><mask></mask></svg>

No cenário acima, temos dois consumidores, cada um com um offset diferente. Mandar e-mails é um processo mais demorado que salvar no ambiente analítico, então é normal o *offset* da mensageria ficar "atrasado" em relação ao processo analítico.

Essa abordagem de PubSub é mais flexível, pois facilita o cenário de múltiplos consumidores, que é bastante recorrente. Por que utilizar filas então? A simplicidade é o principal motivo, já que o paradgima PubSub tem vários detalhes que precisam ser tratados pelo consumidor.

Ao trabalhar com *offsets*, existem diferentes formas de lidar com a atualização a depender das semânticas de consumo: *at-most-once*, *exactly-one* e *at-least-one*. Usando filas, basta dar um "ack" para cada mensagem indivualmente para garantir um consumo *exactly-once*, que é o mais simples de se trabalhar.

# Arquitetos e programadores

Em geral, os *trade-offs* de síncrono e assíncrona se repetem, independente do problema de negócio e do tipo de broker utilizado. Da perspectiva de arquitetura, quase sempre é melhor ser assíncrono e no modelo PubSub, mas programadores ficam ressabiados com os desafios de implementação.

Arquitetos se preocupam muito com escalabilidade e custos, problemas que comunicação assíncrona é excelente. Para os desenvolvedores, por outro lado, é necessário mais esforço para sustentação e os desafios de desenvolvimento são maiores.

O mundo seria mais simples para programadores, se tudo fosse uma API REST síncrona, mas a realidade é que precisamos lidar com tópicos e o paradigma PubSub.

## Garantindo *exactly-once* 

A mensageria é um problema que se encaixa bem com a ideia de eventos, mas é necessário cuidado ao usar tópicos ao invés de fila. A semântica de consumo depende da natureza da comunicação, uma decisão que precisa ser tomada com o negócio em vista.

Podemos consumir um tópico seguindo uma dessas abordagens:

 * *at-most-once* significa que a mensagem consumida uma vez, mas pode ser perdida;
 * *at-least-once* significa que todas as mensagens serão consumidas, mas pode serconsumida múltiplas vezes; 
 * *exactly-once* significa que todas as mensagens serão consumidas uma única vez.

Para o usuário, idealmente seria tudo trabalhar como *exactly-once*, mas as outras opções existem por algum motivo. Para garantir *exactly-once* com tópicos, é necessário um controle externo de offsets e fica muito complicado escalar o consumo.

Pensando em e-mails – a despeito das dificuldades – é interessante pensar em uma abordagem *exactly-once*. Mensagens enviadas por e-mails normalmente não demandam tanta tempestividade, então a questão de escalabilidade é menor. Por outro lado, enviar múltiplos e-mails é algo ruim para experiência e pode ser classificado como spam pelos serviços. Não enviar depende muito da natureza, mas pensando em um fluxo de compras que estamos discutindo, acho importante que todos sejam enviados.

A discussão da melhor abordagem seria muito diferente, se pensarmos em mensageria de notificações para uma rede social, que normalmente é um cenário de grande volume e menor criticidade. Nesse cenário, as vantagens de escalabilidade de uma abordagem *at-most-once* ou *at-least-once*  pode valer a pena.

Focando primeiro no cenário *exactly-once*, podemos nos basear na solução do [tutorial da Confluent](https://docs.confluent.io/kafka-clients/python/current/overview.htm), que é a implementação mais simples possível.


```python
def basic_consume_loop(consumer, topics):
    try:
        consumer.subscribe(topics)

        while True:
            msg = consumer.poll(timeout=1.0)
            if msg is None: continue

            if msg.error():
                if msg.error().code() == KafkaError._PARTITION_EOF:
                    # End of partition event
                    sys.stderr.write('%% %s [%d] reached end at offset %d\n' %
                                     (msg.topic(), msg.partition(), msg.offset()))
                elif msg.error():
                    raise KafkaException(msg.error())
            else:
                msg_process(msg)
    finally:
        # Close down consumer to commit final offsets.
        consumer.close()

```

Nessa solução, cada mensagem consumida é processada, mas não há controle explícito dos *offsets*. Como o objetivo é trabalhar com *exactly-once*, o ideal é controlar a atualização manualmente e de forma síncrona. 

```python
def consume_loop(consumer, topics):
    try:
        consumer.subscribe(topics)

        msg_count = 0
        while running:
            msg = consumer.poll(timeout=1.0)
            if msg is None: continue

            if msg.error():
                if msg.error().code() == KafkaError._PARTITION_EOF:
                    # End of partition event
                    sys.stderr.write('%% %s [%d] reached end at offset %d\n' %
                                     (msg.topic(), msg.partition(), msg.offset()))
                elif msg.error():
                    raise KafkaException(msg.error())
            else:
                msg_process(msg)
                msg_count += 1
                if msg_count % MIN_COMMIT_COUNT == 0:
                    consumer.commit(asynchronous=False)
    finally:
        # Close down consumer to commit final offsets.
        consumer.close()
```

Se `MIN_COMMIT_COUNT = 1`, aparentemente é garantido o consumo *exactly-once* . Mas e se houver um erro ao executar `msg_process` de uma única mensagem? Nesse cenário, se faz necessário controle externo – fila morta, banco de dados, cache – para guardar as mensagens que deram erro.

```python
def consume_loop(consumer, topics):
    try:
        consumer.subscribe(topics)

        msg_count = 0
        while running:
            msg = consumer.poll(timeout=1.0)
            if msg is None: continue

            if msg.error():
                if msg.error().code() == KafkaError._PARTITION_EOF:
                    # End of partition event
                    sys.stderr.write('%% %s [%d] reached end at offset %d\n' %
                                     (msg.topic(), msg.partition(), msg.offset()))
                elif msg.error():
                    raise KafkaException(msg.error())
            else:
                if msg_process(msg):
                  msg_count += 1 
                else:
                  save_dlq(msg)
                
                if msg_count % MIN_COMMIT_COUNT == 0:
                    consumer.commit(asynchronous=False)
    finally:
        # Close down consumer to commit final offsets.
        consumer.close()
```

Sem um local para salvar as mensagens com erro, é necessário parar o processamento. Não é possível atualizar o *offset* para a mensagem $$ x_{i} $$, se existe uma mensagem $$ x_{j}$$ $$ \forall j < i $$ não processada.

Para um cenário *exactly-once*, as filas são uma abstração mais adequada que os tópicos, por conta dos `acks` por mensagem.

Apesar de não recomendável, é possível simplesmente deixar na fila as mensagens com erros. O [SQS da Amazon](https://aws.amazon.com/what-is/dead-letter-queue/) tem o recurso de fila morta (DLQ) integrado e destacado na UI, que facilita muito ter uma solução sustentável para esses casos.

No caso do tópico Kafka, o usuário precisa estar ciente desse problema e implementar uma solução por fora. Ou seja, não é uma tarefa impossível, mas cabe ao usuário ter cuidado por não ser o caso de uso mais adequado. Em geral, costumo adotar a semântica *at-least-once* e tratar o problema depois, como é comum no cenário de analytics.

## Menos garantias, mais escala

