---
layout: post
title: "E esse tal de gRPC?"
comments: true
description: "As vantagens e desvantagens do RPC"
keywords: "gRPC, Rest, Rust, Python"
---

Eu ouvi o termo RPC há pouco tempo atrás, um [tweet do Elon Musk](https://twitter.com/elonmusk/status/1591853644944932865) atribuindo ao excesso de chamadas RPC, a culpa para a lentidão do aplicativo do Twitter.

Quando fui pesquisar o que era [RPC](https://en.wikipedia.org/wiki/Remote_procedure_call), me senti um pouco mal por nunca ter ouvido falar. Quando usava [thrift](https://thrift.apache.org) para conectar ao Hive, não imaginava ser um protocolo RPC, que poderia ser usado para comunicação entre serviços de diferentes linguagens.

Não imagino usar protocolos RPCs com frequência, agora que descobri a existência deles, mas entram na categoria de "é bom saber que isso existe". Ou não?

Imaginei que a popularização de sistemas distribuídos e arquiteturas de microsserviços, colocariam esses protocolos com certo destaque, mas não parece ser o caso.

Para entender o porquê, tentei comparar um mesmo serviço, usando RPC e o velho conhecido REST.

## Usando o gRPC

Para testar a solução RPC, optei por testar o [gRPC do Google](https://grpc.io/about/), pois parecer ser a solução de RPC mais popular atualmente com suporte às linguagens mais populares. Além disso, já conhecia um pouco os [Protobufs](https://protobuf.dev), que é utilizado no gRPC e remete aos JSONs normalmente utilizados em REST.

O problema que vou resolver, é reaproveitado do [post anterior](/2023/03/04/engenharia-dados.html). A ideia é criar um serviço que retorna, para um dado cliente, os resultados de um modelo de machine learning multi-classe.

Os resultados desse modelo está pré-calculado e armazenado no Redis, então o serviço irá simplesmente receber um `id_client` de entrada e retornar um dicionário com as classes do modelo e o valor atribuído a cada uma delas.

A base do gRPC, é a definição dos objetos e serviços usando o Protobufs. Conforme descrição acima, temos o seguinte contrato para o serviço:

```protobuf
syntax="proto3";

message PredictionRequest {
    string id_client = 1;
}

message Prediction {
    string class_name = 1;
    float value = 2;
}

message PredictionResponse {
    repeated Prediction predictions = 1;
}

service Predictions {
    rpc GetPredictions (PredictionRequest) returns (PredictionResponse);
}
```

A partir desse especificação, o gRPC gera códigos que depois serão utilizados pelo servidores e clientes. Em Python, usamos um comando nesse formato para geração desses códigos:

```bash
python -m grpc_tools.protoc -I ../protobufs --python_out=. --grpc_python_out=. ../protobufs/predictions.proto
```

São gerados dois arquivos `predictions_pb2.py` e `predictions_pb2_grpc.py`, que serão depois utilizados para construção do servidor:

```python
import redis
import grpc
from concurrent import futures

from predictions_pb2 import (
    PredictionResponse,
    Prediction
)

from predictions_pb2_grpc import (
    PredictionsServicer,
    add_PredictionsServicer_to_server
)

r = redis.Redis(
    host='localhost',
    port=6379)


class PredictionService(PredictionsServicer):

    def GetPredictions(self, request, context):
        
        key = f"predictions:{request.id_client}"
        predictions = r.hgetall(key)

        predictions = [Prediction(class_name=k.decode("utf-8"),
                                  value=float(v))
                       for k, v
                       in predictions.items()]

        return PredictionResponse(predictions=predictions)

def serve():

    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    add_PredictionsServicer_to_server(
        PredictionService(),
        server
    )

    server.add_insecure_port("[::]:50051")
    server.start()
    server.wait_for_termination()

if __name__ == "__main__":
    serve()

```
A implementação do protocolo não é complexa e nem trabalhosa, mas a documentação oficial não achei muito boa e não encontrei muitos exemplos, o melhor material passo-a-passo que encontrei foi o [tutorial do Real Python](https://realpython.com/python-microservices-grpc/).

